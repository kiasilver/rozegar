/**
 * API ???? ?????? ??????????
 * ??? API ???????? ?? ?? RSS feed ? ?? ?? HTML page ??????? ???
 */

import { NextResponse } from 'next/server';
import { prisma } from '@/lib/core/prisma';
import Parser from 'rss-parser';

// ??????? ?? undici ???? ????? ???? (?? Next.js 16+)
let undiciFetch: typeof fetch | null = null;
try {
  // ?? Next.js 16? fetch ?? undici ??????? ??????
  // ??? ????????? ???????? ?? undici ??????? ???? ???? ????? ?????
  if (typeof process !== 'undefined' && process.versions?.node) {
    // ??????? ?? fetch ??????? ?? ?? Next.js 16 ?? undici ??????? ??????
    undiciFetch = globalThis.fetch;
  }
} catch (e) {
  // ??? undici ?? ????? ????? ?? fetch ??????? ??????? ???????
  undiciFetch = globalThis.fetch;
}

// RSS Parser
const rssParser = new Parser({
  timeout: 60000,
  maxRedirects: 5,
  customFields: {
    item: [
      ['media:content', 'mediaContent', { keepArray: true }],
      ['media:thumbnail', 'mediaThumbnail', { keepArray: true }],
      ['enclosure', 'enclosure', { keepArray: true }],
      ['content:encoded', 'contentEncoded'],
    ],
  },
  headers: {
    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
    'Accept': 'application/rss+xml, application/xml, text/xml, */*',
    'Accept-Language': 'fa-IR,fa;q=0.9,en-US;q=0.8,en;q=0.7',
  },
});

// ??????? ?? fetch (?? Node.js 18+ ?? ???? built-in ???)
const fetch = globalThis.fetch || (() => {
  const https = require('https');
  const http = require('http');
  return (url: string, options: any = {}) => {
    return new Promise((resolve, reject) => {
      try {
        const urlObj = new URL(url);
        const client = urlObj.protocol === 'https:' ? https : http;
        const req = client.get(url, options.headers || {}, (res: any) => {
          let data = '';
          res.on('data', (chunk: Buffer) => data += chunk.toString());
          res.on('end', () => {
            resolve(new Response(data, {
              status: res.statusCode || 200,
              statusText: res.statusMessage || 'OK',
            }) as Response);
          });
        });
        req.on('error', reject);
      } catch (e) {
        reject(e);
      }
    });
  };
})();

/**
 * ????? ????? ??? URL ?? RSS feed ??? ?? ??
 */
function isRSSFeed(url: string): boolean {
  const lowerUrl = url.toLowerCase();
  return lowerUrl.includes('/rss') ||
    lowerUrl.includes('/feed') ||
    lowerUrl.endsWith('.xml') ||
    lowerUrl.endsWith('.rss');
}

/**
 * ??????? ?????????? ?? RSS feed
 */
async function extractNewspapersFromRSS(rssUrl: string): Promise<Array<{ name: string; url: string; persianName: string }>> {
  const newspapers: Array<{ name: string; url: string; persianName: string }> = [];

  try {
    console.log(`?? ?????? RSS feed ??: ${rssUrl}`);
    const feed = await rssParser.parseURL(rssUrl);

    console.log(`? RSS feed ?????? ??: ${feed.title || '???? ?????'}, ${feed.items.length} ????`);

    for (const item of feed.items) {
      let imageUrl: string | undefined;

      // ??????? ????? ?? enclosure
      if (item.enclosure && item.enclosure.url) {
        const enclosureUrl = item.enclosure.url;
        const enclosureType = item.enclosure.type || '';
        if (enclosureUrl.match(/\.(jpg|jpeg|png|webp|gif|svg|bmp)(\?|$)/i) ||
          enclosureType.startsWith('image/')) {
          imageUrl = enclosureUrl;
        }
      }

      // ??????? ????? ?? media:content
      if (!imageUrl && item.mediaContent) {
        const media = Array.isArray(item.mediaContent) ? item.mediaContent[0] : item.mediaContent;
        if (media?.$?.url) {
          imageUrl = media.$.url;
        } else if (media?.url) {
          imageUrl = media.url;
        }
      }

      // ??????? ????? ?? media:thumbnail
      if (!imageUrl && item.mediaThumbnail) {
        const thumb = Array.isArray(item.mediaThumbnail) ? item.mediaThumbnail[0] : item.mediaThumbnail;
        if (thumb?.$?.url) {
          imageUrl = thumb.$.url;
        } else if (thumb?.url) {
          imageUrl = thumb.url;
        }
      }

      // ??????? ????? ?? description ?? content:encoded
      if (!imageUrl) {
        const content = item.contentEncoded || item.content || (item as any).description || '';
        if (content) {
          const imgMatch = content.match(/<img[^>]+src=["']([^"']+)["']/i);
          if (imgMatch && imgMatch[1]) {
            imageUrl = imgMatch[1].replace(/&amp;/g, '&');
          }
        }
      }

      // ??? ????? ???? ??
      if (imageUrl) {
        // ??????? ??? ?? title
        const title = item.title || '';
        // ???? RSS feed? ?? title ?? ????? ??? ??????? ???????
        const newspaperName = title.trim() || '???????';

        // ???? RSS feed? ??? ????????? ?? ????? ????? ?? ?? ????? ??????? ?? ??? ????????
        // (??? RSS feed ??????? ???? ????? ??? ?? ??????????)
        // ??? ??? ????????? ??? ?????????? ?? ??????? ????? ???????
        const shouldInclude = isEconomicNewspaper(newspaperName) ||
          isEconomicNewspaper(imageUrl) ||
          newspaperName.toLowerCase().includes('??????') ||
          newspaperName.toLowerCase().includes('eghtesad') ||
          newspaperName.toLowerCase().includes('economic');

        // ???? RSS feed? ??? ??????? ?? ???????? (????? ??????? ??????? ???)
        if (shouldInclude) {
          const persianName = getPersianName(newspaperName);
          newspapers.push({
            name: newspaperName,
            url: imageUrl,
            persianName: persianName,
          });
        }
      }
    }

    console.log(`? ${newspapers.length} ??????? ?? RSS feed ??????? ??`);
  } catch (error: any) {
    console.error('? ??? ?? ?????? RSS feed:', error);
    throw error;
  }

  return newspapers;
}

/**
 * Mapping ??? ??????????? ??????? ?? ??????? ?? ?????
 */
const economicNewspaperNames: Record<string, string> = {
  // ??????????? ???? ???????
  'DonyayeEghtesad': '????? ??????',
  'JahanSanat': '???? ????',
  'Sarmayeh': '??????',
  'TejaratFarda': '????? ????',
  'Bourse': '????',
  'EghtesadNews': '?????? ????',
  'EghtesadOnline': '?????? ??????',
  'Kargozaran': '?????????',
  'BoursePress': '???? ???',
  'Tejarat': '?????',
  'Eghtesad': '??????',
  'Bazar': '?????',
  'Sanat': '????',
  'SarmayehGozari': '????????????',
  'Mali': '????',
  'Banki': '?????',
  'BourseNews': '???? ????',
  'EghtesadIran': '?????? ?????',
  'TejaratNews': '????? ????',
  'AsreTosee': '??? ?????',
  'AsrGhanoon': '??? ?????',

  // ??????????? ??????? ?????
  'AbrarEghtesadi': '????? ???????',
  'AkhbarSanat': '????? ????',
  'EghtesadPooya': '?????? ????',
  'EghtesadSaramad': '?????? ?????',
  'EghtesadKish': '?????? ???',
  'EghtesadeMardom': '?????? ????',
  'EghtesadeMeli': 'Ø§Ù‚ØªØµØ§Ø¯ Ù…Ù„ÛŒ',
  'EghtesadMardom': 'Ø§Ù‚ØªØµØ§Ø¯ Ù…Ø±Ø¯Ù…',
  'EghtesadMeli': 'Ø§Ù‚ØªØµØ§Ø¯ Ù…Ù„ÛŒ',
  'TejaratOnline': 'ØªØ¬Ø§Ø±Øª Ø¢Ù†Ù„Ø§ÛŒÙ†',
  'Jahan-e-Eghtesad': '???? ??????',
  'JahaneEghtesad': '???? ??????', // ???? ?? ????
  'JahanEghtesad': '???? ??????', // ???? e
  'Eskenas': '??????',
  'Eskanass': '??????',
  'EghtesadAyandeh': '?????? ?????',
  'EghtesadAyande': '?????? ?????',
  'Emruz': '?????',
  'Emrooz': '?????',
  'Sarmaye': '????',
  'Khob': '???',
  'Khoob': '???',
  'Ruzegar': '??????',
  'RuzegareMaden': '?????? ????',
  'RuzegarMaden': '?????? ????',
  'Shoroo': '????',
  'Shorou': '????',
  'Samat': '???',
  'Semat': '???',
  'MojavezeEghtesadi': '?????? ???????',
  'MojavezeEghtesad': '?????? ???????',
  'NagheEghtesad': '??? ??????',
  'NagheEghtesadi': '??? ??????',
  'HadafVaEghtesad': '??? ? ??????',
  'HadafEghtesad': '??? ? ??????',

  // ??????????? ???? ?? ???? ??? ??????? ?????
  'Shargh': '???',
  'Etemaad': '??????',
  'JaameJam': '??? ??',
  'JomhouriEslami': '?????? ??????',
  'ArmanMeli': '????? ???',
  'Asia': '????',
  'MardomSalari': '??????????',
  'Ghods': '???',
};

/**
 * ????? ????? ??? ?? ??????? ??????? ??? ?? ??
 */
function isEconomicNewspaper(name: string): boolean {
  const lowerName = name.toLowerCase();

  // ???? ????? ????? ??????????? ???????
  const economicKeywords = [
    'eghtesad', '??????',
    'donyaye', '?????',
    'jahan', '????',
    'sarmayeh', '??????',
    'tejarat', '?????',
    'bourse', '????',
    'bazar', '?????',
    'sanat', '????',
    'mali', '????',
    'banki', '?????',
    'kargozaran', '?????????',
  ];

  return economicKeywords.some(keyword => lowerName.includes(keyword));
}

/**
 * ????? ??? ??????? ?? ?????
 */
function getPersianName(englishName: string): string {
  // ??? ?? mapping ????? ????? ?? ?? ??????? ??
  if (economicNewspaperNames[englishName]) {
    return economicNewspaperNames[englishName];
  }

  // ??? ??? ?? ???? ????? ???? ??????? ???? ?? ???????
  if (/[\u0600-\u06FF]/.test(englishName)) {
    return englishName;
  }

  // ????? ?????? ??????? ??????? ?? ?????
  const name = englishName.trim();

  // ????? ????? ????
  let persianName = name
    .replace(/Eghtesad/gi, '??????')
    .replace(/Eghtesade/gi, '??????')
    .replace(/Donyaye/gi, '?????')
    .replace(/Jahan/gi, '????')
    .replace(/Jahan-e-/gi, '???? ')
    .replace(/Jahane/gi, '???? ')
    .replace(/Sanat/gi, '????')
    .replace(/Akhbar/gi, '?????')
    .replace(/Tejarat/gi, '?????')
    .replace(/Online/gi, '??????')
    .replace(/Sarmayeh/gi, '??????')
    .replace(/Bourse/gi, '????')
    .replace(/Bazar/gi, '?????')
    .replace(/Mali/gi, '????')
    .replace(/Banki/gi, '?????')
    .replace(/Kargozaran/gi, '?????????')
    .replace(/Abrar/gi, '?????')
    .replace(/Pooya/gi, '????')
    .replace(/Saramad/gi, '?????')
    .replace(/Kish/gi, '???')
    .replace(/Mardom/gi, '????')
    .replace(/Meli/gi, '???')
    .replace(/Farda/gi, '????')
    .replace(/News/gi, '????')
    .replace(/Press/gi, '???')
    .replace(/Iran/gi, '?????');

  // ??? ????? ????? ?? ? ??? ????? ???? ?? ?? ???????
  if (persianName !== name && persianName.length > 0) {
    return persianName.trim();
  }

  // ?? ??? ??? ????? ??? ??????? ?? ???????
  return englishName;
}

/**
 * ???? URL pdfviewer.php ???? ???????
 */
function buildPDFViewerUrl(newspaperName: string, imageUrl?: string): string | null {
  // ??????? ????? ?? imageUrl
  if (imageUrl && imageUrl.includes('/Archive/')) {
    // ????: https://www.pishkhan.com/Archive/1404/09/14040916/DonyayeEghtesad_s.jpg
    const dateMatch = imageUrl.match(/\/Archive\/\d+\/\d+\/(\d+)\//i);
    if (dateMatch) {
      const date = dateMatch[1]; // 14040916
      return `https://www.pishkhan.com/pdfviewer.php?paper=${newspaperName}&date=${date}`;
    }
  }

  // ??? ????????? ?? imageUrl ??????? ????? ?? ????? ????? ??????? ????
  const todayDate = getTodayPersianDate();
  return `https://www.pishkhan.com/pdfviewer.php?paper=${newspaperName}&date=${todayDate}`;
}

/**
 * ??????? ???? ????? PDF ?? ???? pdfviewer.php
 * ??? ???? ??? ?? ??? ????? PDF ?? ?? iframe ?? embed ????? ??????
 */
async function extractPDFFromViewer(viewerUrl: string, retryCount: number = 0): Promise<string | null> {
  try {
    console.log(`?? ?? ??? ?????? ???? pdfviewer (???? ${retryCount + 1}): ${viewerUrl}`);

    // ??????? ????????? ?? URL
    const urlObj = new URL(viewerUrl);
    const paper = urlObj.searchParams.get('paper');
    const date = urlObj.searchParams.get('date');

    // ??? ????? ??? ???? ????? ?????? ?? PDF ????? ??? (7 ????? ??? delay ?? JavaScript)
    if (retryCount === 0) {
      console.log(`? ????? ????? ??? PDF (7 ?????)...`);
      await new Promise(resolve => setTimeout(resolve, 7000));
    }

    // ?????? ???? pdfviewer ? ????? HTML (?? retry)
    const response = await fetchWithRetry(
      viewerUrl,
      {
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
          'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
          'Accept-Language': 'fa-IR,fa;q=0.9,en-US;q=0.8,en;q=0.7',
          'Connection': 'keep-alive',
        },
        redirect: 'follow',
      },
      2, // maxRetries (???? ??? ??? ???? retry ????)
      30000 // timeout: 30 seconds
    );

    // ????? URL ????? - ??? redirect ??? ?? PDF? ?? ?? ??????? ??
    const finalUrl = response.url;
    if (finalUrl !== viewerUrl && finalUrl.includes('.pdf') && finalUrl.includes('/Archive/')) {
      console.log(`? Redirect ?? PDF ???? ??: ${finalUrl}`);
      return finalUrl;
    }

    // ????? Content-Type - ??? PDF ???? ?? URL ??????? ??
    const contentType = response.headers.get('content-type');
    if (contentType && contentType.includes('pdf')) {
      console.log(`? ???? PDF ???: ${finalUrl}`);
      return finalUrl;
    }

    if (!response.ok) {
      console.warn(`?? ??????? ???? pdfviewer ?? ?????? ???: ${response.status}`);
      return null;
    }

    const html = await response.text();
    const cleanHtml = html.replace(/<!\[CDATA\[([\s\S]*?)\]\]>/gi, '$1');

    // ??? 1: ??????? paper ID ? id ?? JavaScript ? ??????? ?? endpoint AJAX
    // ?? JavaScript ????????: {date:14040916,paper:13,id:87}
    const paperIdMatch = cleanHtml.match(/paper\s*:\s*(\d+)/i);
    const idMatch = cleanHtml.match(/id\s*:\s*(\d+)/i);

    if (paperIdMatch && idMatch && date) {
      const paperId = paperIdMatch[1];
      const id = idMatch[1];

      try {
        // ???????? endpoint AJAX ?? ID ??? ???? (?? retry)
        const ajaxResponse = await fetchWithRetry(
          'https://www.pishkhan.com/tools/PDFFiles/PDFFiles.php',
          {
            method: 'POST',
            headers: {
              'Content-Type': 'application/x-www-form-urlencoded',
              'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
              'Referer': viewerUrl,
              'X-Requested-With': 'XMLHttpRequest',
              'Connection': 'keep-alive',
            },
            body: `date=${date}&paper=${paperId}&id=${id}`,
          },
          2, // maxRetries
          20000 // timeout: 20 seconds
        );

        const ajaxText = await ajaxResponse.text();
        console.log(`?? ???? AJAX (paper=${paperId}, id=${id}): ${ajaxText.substring(0, 200)}`);

        // ????? ????? ??? ???? ?? URL PDF ???
        if (ajaxText && ajaxText.trim() !== 'null' && ajaxText.trim() !== '') {
          // ??? ???? ?? URL ???? ???
          if (ajaxText.includes('http') && ajaxText.includes('.pdf')) {
            const pdfUrl = ajaxText.trim();
            console.log(`? ???? PDF ?? AJAX ???? ??: ${pdfUrl}`);
            return pdfUrl;
          }
          // ??? ???? ?? ???? ???? ???
          if (ajaxText.includes('/Archive/') && ajaxText.includes('.pdf')) {
            const pdfUrl = ajaxText.trim().startsWith('/')
              ? `https://www.pishkhan.com${ajaxText.trim()}`
              : `https://www.pishkhan.com/${ajaxText.trim()}`;
            console.log(`? ???? PDF ?? AJAX ???? ??: ${pdfUrl}`);
            return pdfUrl;
          }
        }
      } catch (ajaxError: any) {
        console.log(`?? ??? ?? ???????? AJAX: ${ajaxError.message}`);
      }
    }

    // ??? 2: ????? ????? ??? JavaScript ????? pdfLink ?? set ???? ???
    // ?? JavaScript ????????: var pdfLink = "...";
    const pdfLinkMatch = cleanHtml.match(/var\s+pdfLink\s*=\s*["']([^"']*\/Archive\/[^"']*\d+\.pdf)["']/i);
    if (pdfLinkMatch && pdfLinkMatch[1]) {
      let pdfUrl = pdfLinkMatch[1];
      if (!pdfUrl.startsWith('http')) {
        pdfUrl = `https://www.pishkhan.com${pdfUrl.startsWith('/') ? '' : '/'}${pdfUrl}`;
      }
      console.log(`? ???? PDF ?? ????? JavaScript ???? ??: ${pdfUrl}`);
      return pdfUrl;
    }

    // ?????? ???? PDF ?? ????
    // ???? PDF ?? ????: /Archive/1404/09/14040916/NewspaperName123456789012345678.pdf
    // ?? ??? ?? ????? ???? ??????? ?? ?????? ?????? ???
    const patterns = [
      // ?????? ?? href ???? pdfbtn (?????? ??? - ??? JavaScript ?? ?? set ??????)
      /<a[^>]*id=["']pdfbtn["'][^>]*href=["']([^"']*\/Archive\/[^"']*\d+\.pdf)["']/gi,
      /<a[^>]*id=["']pdfbtn["'][^>]*href=["']([^"']*\.pdf)["']/gi,
      // ?????? ?????? URL PDF ?? ??? ?? ?????
      // ????: https://www.pishkhan.com/Archive/1404/09/14040916/AkhbarSanat651079798104495754152458.pdf
      /https?:\/\/[^"'\s<>]*\/Archive\/[^"'\s<>]*\/[^"'\s<>]*\d+\.pdf/gi,
      // ?????? ?? iframe ?? ???
      /<iframe[^>]*src=["']([^"']*\/Archive\/[^"']*\d+\.pdf)["']/gi,
      /<iframe[^>]*src=["']([^"']*\.pdf[^"']*)["']/gi,
      // ?????? ?? embed ?? ???
      /<embed[^>]*src=["']([^"']*\/Archive\/[^"']*\d+\.pdf)["']/gi,
      /<embed[^>]*src=["']([^"']*\.pdf[^"']*)["']/gi,
      // ?????? ???? ?????? PDF ?? href (?? ???)
      /href=["']([^"']*\/Archive\/[^"']*\d+\.pdf)["']/gi,
      /href=["']([^"']*\/Archive\/[^"']*\.pdf)["']/gi,
      // ?????? ?? JavaScript - ???? PDF ?? ??????? (?? ???)
      /(?:pdfUrl|pdf_url|fileUrl|file_url|src|url|pdfPath|pdf_path|downloadUrl|download_url)\s*[:=]\s*["']([^"']*\/Archive\/[^"']*\d+\.pdf)["']/gi,
      /(?:pdfUrl|pdf_url|fileUrl|file_url|src|url|pdfPath|pdf_path)\s*[:=]\s*["']([^"']*\.pdf)["']/gi,
      // ?????? ?? data attributes (?? ???)
      /data-(?:src|url|pdf|file|href)=["']([^"']*\/Archive\/[^"']*\d+\.pdf)["']/gi,
      /data-(?:src|url|pdf|file)=["']([^"']*\.pdf[^"']*)["']/gi,
      // ?????? ?? onclick (?? ???)
      /onclick=["'][^"']*["']([^"']*\/Archive\/[^"']*\d+\.pdf)["']/gi,
      // ?????? ?? JSON (?? ???)
      /"url"\s*:\s*["']([^"']*\/Archive\/[^"']*\d+\.pdf)["']/gi,
      /"src"\s*:\s*["']([^"']*\/Archive\/[^"']*\d+\.pdf)["']/gi,
      /"file"\s*:\s*["']([^"']*\/Archive\/[^"']*\d+\.pdf)["']/gi,
      // ?????? ?? window.location (?? ???)
      /(?:window\.location|location\.href)\s*=\s*["']([^"']*\/Archive\/[^"']*\d+\.pdf)["']/gi,
      // ?????? ?? object tag (?? ???)
      /<object[^>]*data=["']([^"']*\/Archive\/[^"']*\d+\.pdf)["']/gi,
      // ?????? ?????? ?? ??? (?? ???)
      /\/Archive\/[^"'\s<>]*\/[^"'\s<>]*\d+\.pdf/gi,
    ];

    for (const pattern of patterns) {
      try {
        const matches = [...cleanHtml.matchAll(pattern)];
        for (const match of matches) {
          // ????? ??? ???????? capture
          for (let i = 1; i < match.length; i++) {
            if (match[i]) {
              let pdfUrl = match[i].trim();

              // ??? ?????????? ?????
              pdfUrl = pdfUrl.replace(/['"]/g, '').replace(/[;,\)}]/g, '').replace(/&amp;/g, '&');

              // ??? URL ???? ????? ???? ??
              if (!pdfUrl.startsWith('http')) {
                if (pdfUrl.startsWith('/')) {
                  pdfUrl = `https://www.pishkhan.com${pdfUrl}`;
                } else if (pdfUrl.includes('/Archive/')) {
                  pdfUrl = `https://www.pishkhan.com/${pdfUrl}`;
                } else {
                  continue; // ??? URL ????? ????? ?? ??
                }
              }

              // ????? ????? ?????? PDF ??? ? ???? Archive ? ??? ?? ???????
              // ????: /Archive/1404/09/14040916/NewspaperName123456789012345678.pdf
              if (pdfUrl.includes('.pdf') && pdfUrl.includes('/Archive/')) {
                // ????? ????? ??? ??? ?? ?????? ??? ???? ???? ???? (???? ??????? ?? ???? generate ???)
                const pdfNameMatch = pdfUrl.match(/\/([^\/]+)\.pdf$/i);
                if (pdfNameMatch && pdfNameMatch[1]) {
                  const pdfName = pdfNameMatch[1];
                  // ????? ????? ??? ??? ?? ?????? ??? ???? ????
                  const hasNumber = /\d{10,}/.test(pdfName);
                  if (hasNumber) {
                    console.log(`? ???? PDF ?? ??? ???? ??: ${pdfUrl}`);
                    return pdfUrl;
                  } else {
                    // ??? ??? ?????? ??? ?? ???? ??? ????? ????
                    console.log(`? ???? PDF ???? ?? (???? ???): ${pdfUrl}`);
                    return pdfUrl;
                  }
                } else {
                  console.log(`? ???? PDF ???? ??: ${pdfUrl}`);
                  return pdfUrl;
                }
              }
            }
          }

          // ??? match[0] ???? ???? (???? patterns ???? capture group)
          if (match[0] && !match[1]) {
            let pdfUrl = match[0].trim();
            pdfUrl = pdfUrl.replace(/['"]/g, '').replace(/[;,\)}]/g, '').replace(/&amp;/g, '&');

            if (!pdfUrl.startsWith('http')) {
              if (pdfUrl.startsWith('/')) {
                pdfUrl = `https://www.pishkhan.com${pdfUrl}`;
              } else if (pdfUrl.includes('/Archive/')) {
                pdfUrl = `https://www.pishkhan.com/${pdfUrl}`;
              } else {
                continue;
              }
            }

            if (pdfUrl.includes('.pdf') && pdfUrl.includes('/Archive/')) {
              console.log(`? ???? PDF ???? ?? (?? match[0]): ${pdfUrl}`);
              return pdfUrl;
            }
          }
        }
      } catch (e) {
        // ??? pattern ??? ????? ????? ???
        continue;
      }
    }

    // ??? ???? ??? ? ???? ???? ?????????? ?????? ???? ???? (??? ?? ??? ?????)
    if (retryCount < 2) {
      console.log(`? ???? PDF ???? ???? ????? ${(retryCount + 1) * 5} ????? ? ???? ????...`);
      await new Promise(resolve => setTimeout(resolve, (retryCount + 1) * 5000));
      return extractPDFFromViewer(viewerUrl, retryCount + 1);
    }

    // ??? ???? ??? ? ???? ???? ?????????? ?????? ???? ???? (??? ?? ??? ?????)
    if (retryCount < 2) {
      console.log(`? ???? PDF ???? ???? ????? ${(retryCount + 1) * 5} ????? ? ???? ????...`);
      await new Promise(resolve => setTimeout(resolve, (retryCount + 1) * 5000));
      return extractPDFFromViewer(viewerUrl, retryCount + 1);
    }

    // ??? ???? ???? ??? ?? ?? URL ??? pdfviewer ??????? ??
    // ???? ????? ????????? ???????? ?? pdfviewer ?????? ????
    console.log(`?? ???? PDF ?????? ???? ???? ??????? ?? pdfviewer URL`);
    return viewerUrl;
  } catch (error: any) {
    console.error(`? ??? ?? ??????? PDF ?? viewer: ${error.message}`);
    return null;
  }
}

/**
 * ?????? ? ????? PDF ?? ????
 * ????? ?? pdfviewer.php ??????? ??????? ????? ??????? ? ??? PDF ????? ?? ?????? ??????
 */
async function downloadAndSavePDF(pdfViewerUrl: string, newspaperName: string, persianName: string): Promise<string | null> {
  try {
    // ????? ????? ??? PDF ????? ?????? ??? ?? ??
    const fs = await import('fs/promises');
    const path = await import('path');
    const { slugifyPersian } = await import('@/lib/utils/slugify-fa');

    // Ù†Ø§Ù… ÙØ§ÛŒÙ„ Ø±Ø§ Ø¨Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Slug Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ø¨Ø³Ø§Ø²ÛŒÙ…
    // ØªØ§ Ø¨Ø§ mapping Ù‡Ø§ÛŒ ØµÙØ­Ù‡ Ø§ØµÙ„ÛŒ (Newpaper) Ùˆ Ø¢Ø±Ø´ÛŒÙˆ Ù…Ø·Ø§Ø¨Ù‚Øª Ø¯Ù‚ÛŒÙ‚ Ø¯Ø§Ø´ØªÙ‡ Ø¨Ø§Ø´Ø¯
    const safeName = newspaperName.substring(0, 50);
    const today = new Date();
    const persianDate = new Intl.DateTimeFormat('fa-IR', {
      year: 'numeric',
      month: '2-digit',
      day: '2-digit',
      calendar: 'persian',
    }).format(today);
    const dateStr = persianDate.replace(/\//g, '-');
    const filename = `${safeName}-${dateStr}.pdf`;
    const uploadDir = path.default.join(process.cwd(), 'public', 'uploads', 'newspapers');
    const filepath = path.default.join(uploadDir, filename);

    // ????? ????? ??? ???? ?? ??? ???? ????
    try {
      await fs.default.access(filepath);
      const savedPath = `/uploads/newspapers/${filename}`;
      console.log(`? PDF ?? ??? ?????? ??? ???? ??????? ?? ???? ?????: ${savedPath}`);
      return savedPath;
    } catch {
      // ???? ???? ?????? ????? ???????
      console.log(`?? ?? ??? ?????? PDF ?? pdfviewer: ${pdfViewerUrl}`);
    }

    // ????? ????? ?????? ?? PDF ?? pdfviewer ????? ???
    // ??? JavaScript ?? ????? delay=7000 (7 ?????) ???
    // ??? ???? ???????? 10 ????? ????? ????????
    console.log(`? ????? ????? ??? PDF (10 ?????)...`);
    await new Promise(resolve => setTimeout(resolve, 10000));

    // ??????? ???? ????? PDF ?? ???? pdfviewer (?? retry)
    // ??? ???? ???? ????? ??????? ? retry ??????
    const realPdfUrl = await extractPDFFromViewer(pdfViewerUrl, 0);

    if (!realPdfUrl) {
      console.warn(`?? ??????? ???? ????? PDF ?? ???? ???`);
      return null;
    }

    // ??? realPdfUrl ???? pdfViewerUrl ???? ???? ????????? ???? ????? ?? ???? ????
    // ?? ??? ???? ???? ?????? ???? ????
    let finalPdfUrl = realPdfUrl;
    if (realPdfUrl === pdfViewerUrl || !realPdfUrl.includes('.pdf')) {
      console.warn(`?? ???? PDF ????? ???? ???? ???? ????...`);
      // ????? ?????? ? ?????? ???? ????
      console.log(`? ????? 5 ????? ???? ? ???? ????...`);
      await new Promise(resolve => setTimeout(resolve, 5000));
      const retryPdfUrl = await extractPDFFromViewer(pdfViewerUrl, 1);
      if (retryPdfUrl && retryPdfUrl !== pdfViewerUrl && retryPdfUrl.includes('.pdf')) {
        finalPdfUrl = retryPdfUrl;
        console.log(`? ???? PDF ?? ???? ???? ???? ??: ${finalPdfUrl}`);
      } else {
        // ??? ??? ?? ???? ???? ??? ??????? ???????? ?? pdfviewer ?? Accept header ?????? ????
        console.warn(`?? ?? ???? ???? ?? ???? PDF ???? ???? ??? ?????? ?????? ?? pdfviewer...`);
        // ??? ??????? ?? ??? pdfviewer ???????? PDF ??????????? ?? ?? (?? retry)
        try {
          const testResponse = await fetchWithRetry(
            pdfViewerUrl,
            {
              headers: {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
                'Accept': 'application/pdf,*/*',
                'Connection': 'keep-alive',
              },
            },
            2, // maxRetries
            20000 // timeout: 20 seconds
          );
          const testContentType = testResponse.headers.get('content-type');
          if (testContentType && testContentType.includes('pdf')) {
            finalPdfUrl = pdfViewerUrl;
            console.log(`? pdfviewer ???????? PDF ???????????`);
          } else {
            console.warn(`?? pdfviewer PDF ???????????? (${testContentType})`);
            return null;
          }
        } catch (e) {
          console.warn(`?? ??? ?? ??? pdfviewer: ${e instanceof Error ? e.message : String(e)}`);
          return null;
        }
      }
    }

    console.log(`?? ?? ??? ?????? PDF ????? ??: ${finalPdfUrl}`);

    // ?????? PDF (?? retry)
    const response = await fetchWithRetry(
      finalPdfUrl,
      {
        headers: {
          'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
          'Accept': 'application/pdf,*/*',
          'Referer': pdfViewerUrl,
          'Connection': 'keep-alive',
        },
      },
      3, // maxRetries (???? ?????? PDF ????? ???? ???????)
      60000 // timeout: 60 seconds (PDF ???? ??? ???? ????)
    );

    if (!response.ok) {
      console.warn(`?? ??????? PDF ?? ?????? ???: ${response.status}`);
      return null;
    }

    // ????? ????? ??? ???? ?????? PDF ???
    const contentType = response.headers.get('content-type');
    if (!contentType || !contentType.includes('pdf')) {
      // ??? PDF ????? ???? ??? HTML ???? (???? pdfviewer)
      // ?? ??? ???? ???? ?????? ???? ????
      console.warn(`?? ???? PDF ????? ???: ${contentType}`);
      return null;
    }

    const buffer = await response.arrayBuffer();

    // ???? ???? ?????????? (??? ???? ?????)
    await fs.default.mkdir(uploadDir, { recursive: true });

    // ????? ????
    await fs.default.writeFile(filepath, Buffer.from(buffer));

    const savedPath = `/uploads/newspapers/${filename}`;
    console.log(`âœ… PDF Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯: ${savedPath}`);

    return savedPath;
  } catch (error: any) {
    console.error(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF: ${error.message}`);
    return null;
  }
}

/**
 * Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ø°Ø®ÛŒØ±Ù‡ ØªØµÙˆÛŒØ± Ù¾ÛŒØ´â€ŒÙ†Ù…Ø§ÛŒØ´ Ø±ÙˆØ²Ù†Ø§Ù…Ù‡
 */
async function downloadAndSaveImage(imgUrl: string, newspaperName: string, dateStr: string): Promise<string | null> {
  try {
    const fs = await import('fs/promises');
    const path = await import('path');

    const safeName = newspaperName.substring(0, 50);
    const filename = `${safeName}-${dateStr}.jpg`;
    const uploadDir = path.default.join(process.cwd(), 'public', 'uploads', 'newspapers');
    const filepath = path.default.join(uploadDir, filename);

    try {
      await fs.default.access(filepath);
      return `/uploads/newspapers/${filename}`;
    } catch {
      // ÙØ§ÛŒÙ„ ÙˆØ¬ÙˆØ¯ Ù†Ø¯Ø§Ø±Ø¯ØŒ Ø¨Ø§ÛŒØ¯ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø´ÙˆØ¯
    }

    const response = await fetch(imgUrl);
    if (!response.ok) return null;

    const buffer = await response.arrayBuffer();
    await fs.default.mkdir(uploadDir, { recursive: true });
    await fs.default.writeFile(filepath, Buffer.from(buffer));

    console.log(`ğŸ“¸ ØªØµÙˆÛŒØ± Ø±ÙˆØ²Ù†Ø§Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯: /uploads/newspapers/${filename}`);
    return `/uploads/newspapers/${filename}`;
  } catch (e) {
    console.error(`âŒ Ø®Ø·Ø§ Ø¯Ø± Ø¯Ø§Ù†Ù„ÙˆØ¯ ØªØµÙˆÛŒØ±:`, e);
    return null;
  }
}

/**
 * ??????? ???? PDF ?? ???? economics
 * ???????? PDF ?? ?? <a> ?? href ???? pdfviewer.php ?????
 */
function extractPDFLinksFromEconomicsPage(html: string): Map<string, string> {
  const pdfLinks = new Map<string, string>();
  const cleanHtml = html.replace(/<!\[CDATA\[([\s\S]*?)\]\]>/gi, '$1');

  // ???? ???? ??? ???????? PDF
  // ????: <a href="https://www.pishkhan.com/pdfviewer.php?paper=Eskenas&date=14040916">
  const linkRegex = /href=["']([^"']*pdfviewer\.php\?paper=([^&"']+)[^"']*)["']/gi;
  const linkMatches = [...cleanHtml.matchAll(linkRegex)];

  for (const match of linkMatches) {
    if (match[1] && match[2]) {
      let pdfUrl = match[1]
        .replace(/&amp;/g, '&')
        .replace(/&quot;/g, '"')
        .replace(/&#39;/g, "'")
        .trim();

      const newspaperName = match[2];
      // ??? ??? ????? ????? ???? ????
      if (!pdfLinks.has(newspaperName)) {
        pdfLinks.set(newspaperName, pdfUrl);
      }
    }
  }

  return pdfLinks;
}

/**
 * ??????? ??????????? ??????? ?? HTML
 * ??? URL ???? /economics ????? ??? ?????????? ?? ???????? (??? ??? ??????? ?????)
 * @param forceDownload - ??? true ????? PDF??? ?? ??? ??? ????? ?????? ???????? ?????? ?????? ??????
 */
/**
 * Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø±ÙˆØ²Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ Ø§Ù‚ØªØµØ§Ø¯ÛŒ Ø§Ø² HTML
 * @param forceDownload - Ø§Ú¯Ø± true Ø¨Ø§Ø´Ø¯ØŒ PDFÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ Ú©Ø´ Ø´Ø¯Ù‡ Ø¯Ø§Ù†Ù„ÙˆØ¯ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯
 */
async function extractEconomicNewspapers(html: string, sourceUrl?: string, forceDownload: boolean = false): Promise<Array<{ name: string; url: string; persianName: string; pdfUrl?: string }>> {
  const newspapers: Array<{ name: string; url: string; persianName: string; pdfUrl?: string }> = [];

  // Ù„ÛŒÙ†Ú©â€ŒÙ‡Ø§ÛŒ PDF Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± ØµÙØ­Ù‡ economics
  const pdfLinksMap = extractPDFLinksFromEconomicsPage(html);
  console.log(`ğŸ” ${pdfLinksMap.size} Ù„ÛŒÙ†Ú© PDF Ø¯Ø± ØµÙØ­Ù‡ economics Ù¾ÛŒØ¯Ø§ Ø´Ø¯`);

  // Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ CDATA wrapper
  let cleanHtml = html;
  if (html.includes('<![CDATA[')) {
    cleanHtml = html.replace(/<!\[CDATA\[([\s\S]*?)\]\]>/gi, '$1');
  }

  // Ø±Ú¯Ú©Ø³ Ø¨Ø±Ø§ÛŒ Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ØªÚ¯â€ŒÙ‡Ø§ÛŒ Ù„ÛŒÙ†Ú© Ø¨Ù‡ Ø±ÙˆØ²Ù†Ø§Ù…Ù‡
  // Ù…Ø«Ø§Ù„: <a href="https://www.pishkhan.com/rooznameh/Asia" ...>...<img src="..." alt="...">...</a>
  const linkRegex = /<a[^>]+href=["']https?:\/\/www\.pishkhan\.com\/rooznameh\/([^"']+)["'][^>]*>([\s\S]*?)<\/a>/gi;
  const linkMatches = [...cleanHtml.matchAll(linkRegex)];

  console.log(`ğŸ” Ù¾ÛŒØ¯Ø§ Ú©Ø±Ø¯Ù† ${linkMatches.length} Ù„ÛŒÙ†Ú© Ø±ÙˆØ²Ù†Ø§Ù…Ù‡ Ø¯Ø± ØµÙØ­Ù‡`);

  for (const match of linkMatches) {
    try {
      const newspaperSlug = match[1]; // Ù…Ø«Ù„Ø§Ù‹ Asia
      const content = match[2]; // Ù…Ø­ØªÙˆÛŒØ§Øª Ø¯Ø§Ø®Ù„ ØªÚ¯ a

      // Ø§Ø³ØªØ®Ø±Ø§Ø¬ ØªÚ¯ img
      const imgMatch = content.match(/<img[^>]+src=["']([^"']+)["'][^>]*alt=["']([^"']+)["'][^>]*>/i);

      if (imgMatch) {
        let imgUrl = imgMatch[1];
        const altText = imgMatch[2]; // Ø¹Ù†ÙˆØ§Ù† Ø±ÙˆØ²Ù†Ø§Ù…Ù‡ Ùˆ ØªØ§Ø±ÛŒØ® Ø§Ø² alt

        // ØªÙ…ÛŒØ²Ú©Ø§Ø±ÛŒ URL ØªØµÙˆÛŒØ±
        imgUrl = imgUrl.replace(/&amp;/g, '&');

        // Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ù†Ø³Ø®Ù‡ Ø¨Ø§ Ú©ÛŒÙÛŒØª Ø¨Ø§Ù„Ø§ (Ø­Ø°Ù _s)
        if (imgUrl.includes('_s.jpg')) {
          imgUrl = imgUrl.replace('_s.jpg', '.jpg');
        }

        // Ù†Ú©ØªÙ‡ Ù…Ù‡Ù…: Ø³Ø§ÛŒØª Ù¾ÛŒØ´Ø®ÙˆØ§Ù† Ø§ØºÙ„Ø¨ Ù†Ø§Ù…â€ŒÙ‡Ø§ Ø±Ø§ Ø¯Ø± alt Ø§Ø´ØªØ¨Ø§Ù‡ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒØ¯Ù‡Ø¯.
        // Ù…Ø«Ù„Ø§ Ø¹Ú©Ø³ Ø±ÙˆØ²Ù†Ø§Ù…Ù‡ "Ø§Ø¨Ø±Ø§Ø± Ø§Ù‚ØªØµØ§Ø¯ÛŒ" Ø±Ø§ Ø¨Ø§ alt "Ø§Ù‚ØªØµØ§Ø¯ Ø³Ø±Ø¢Ù…Ø¯" Ø°Ø®ÛŒØ±Ù‡ Ù…ÛŒâ€ŒÚ©Ù†Ø¯ Ùˆ Ø¨Ø§Ø¹Ø« 
        // Ø§ÛŒØ¬Ø§Ø¯ Ø±ÙˆØ²Ù†Ø§Ù…Ù‡â€ŒÙ‡Ø§ÛŒ ØªÚ©Ø±Ø§Ø±ÛŒ Ø¨Ø§ ØªØµØ§ÙˆÛŒØ± Ø§Ø´ØªØ¨Ø§Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
        // Ø¨Ù†Ø§Ø¨Ø±Ø§ÛŒÙ†ØŒ Ø§ÙˆÙ„ÙˆÛŒØª Ø§ØµÙ„ÛŒ Ù…Ø§ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² slug (Ø¨Ø®Ø´ englishName Ø¯Ø± URL) Ø§Ø³Øª.
        let persianName = getPersianName(newspaperSlug);

        // Ø§Ú¯Ø± Ù†Ø§Ù… Ø¨Ø±Ú¯Ø´ØªÛŒ ØªÙ…Ø§Ù…Ø§Ù‹ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ùˆ Ù†Ø§Ù… Ù†Ú¯Ø§Ø´Øªâ€ŒØ´Ø¯Ù‡ Ù†Ø¨ÙˆØ¯ØŒ ÙÙ‚Ø· Ø¯Ø± Ø§ÛŒÙ† ØµÙˆØ±Øª Ø§Ø² alt Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
        if (!persianName || /^[a-zA-Z0-9_\-\.]+$/.test(persianName)) {
          const nameMatch = altText.match(/Ø±ÙˆØ²Ù†Ø§Ù…Ù‡\s+(.*?)(?:\s+Ø¯Ø±\s+Ø±ÙˆØ²|$)/);
          if (nameMatch && nameMatch[1]) {
            persianName = nameMatch[1].trim();
          } else {
            persianName = newspaperSlug;
          }
        }

        // Ø¨Ù‡Ø¨ÙˆØ¯ Ù†Ø§Ù… ÙØ§Ø±Ø³ÛŒ Ø¨Ø±Ø§ÛŒ "Asia"
        if (newspaperSlug.toLowerCase() === 'asia' || newspaperSlug.toLowerCase() === 'asiya') {
          persianName = 'Ø±ÙˆØ²Ù†Ø§Ù…Ù‡ Ø¢Ø³ÛŒØ§';
        }

        // Ø³Ø§Ø®Øª PDF Viewer URL
        let pdfViewerUrl = pdfLinksMap.get(newspaperSlug);
        if (!pdfViewerUrl) {
          // Ø¬Ø³ØªØ¬ÙˆÛŒ case-insensitive
          for (const [key, val] of pdfLinksMap.entries()) {
            if (key.toLowerCase() === newspaperSlug.toLowerCase()) {
              pdfViewerUrl = val;
              break;
            }
          }
        }

        // Ø§Ú¯Ø± Ù‡Ù†ÙˆØ² Ù¾ÛŒØ¯Ø§ Ù†Ø´Ø¯ØŒ Ø³Ø§Ø®Øª URL Ø¯Ø³ØªÛŒ
        if (!pdfViewerUrl) {
          pdfViewerUrl = buildPDFViewerUrl(newspaperSlug, imgUrl) || undefined;
        }

        let pdfUrlToReturn: string | undefined = undefined;

        // Ù…Ù†Ø·Ù‚ Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF (Ù…Ø´Ø§Ø¨Ù‡ Ù‚Ø¨Ù„)
        if (pdfViewerUrl) {
          const fs = await import('fs/promises');
          const path = await import('path');
          const { slugifyPersian } = await import('@/lib/utils/slugify-fa');

          const today = new Date();
          const persianDate = new Intl.DateTimeFormat('fa-IR', {
            year: 'numeric', month: '2-digit', day: '2-digit', calendar: 'persian'
          }).format(today);
          const dateStr = persianDate.replace(/\//g, '-');

          const safeName = newspaperSlug.substring(0, 50);
          const filename = `${safeName}-${dateStr}.pdf`;
          const uploadDir = path.default.join(process.cwd(), 'public', 'uploads', 'newspapers');
          const filepath = path.default.join(uploadDir, filename);

          let fileExists = false;
          try {
            await fs.default.access(filepath);
            fileExists = true;
            pdfUrlToReturn = `/uploads/newspapers/${filename}`;
          } catch {
            fileExists = false;
            pdfUrlToReturn = pdfViewerUrl;
          }

          if (forceDownload) {
            if (!fileExists) {
              console.log(`ğŸ“¥ Ø¯Ø§Ù†Ù„ÙˆØ¯ PDF Ø¨Ø±Ø§ÛŒ ${persianName}...`);
              const savedPath = await downloadAndSavePDF(pdfViewerUrl, newspaperSlug, persianName);
              if (savedPath) pdfUrlToReturn = savedPath;
            }

            // Ø¯Ø§Ù†Ù„ÙˆØ¯ Ùˆ Ø°Ø®ÛŒØ±Ù‡ ØªØµÙˆÛŒØ± Ú©Ø§ÙˆØ± Ø¨Ø±Ø§ÛŒ Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ù…Ø´Ú©Ù„Ø§Øª ØªØ·Ø¨ÛŒÙ‚ Ù†Ø§Ù…
            const savedImgPath = await downloadAndSaveImage(imgUrl, newspaperSlug, dateStr);
            if (savedImgPath) {
              imgUrl = savedImgPath;
            }
          }
        }

        newspapers.push({
          name: newspaperSlug,
          url: imgUrl,
          persianName: persianName,
          pdfUrl: pdfUrlToReturn
        });
      }
    } catch (e) {
      console.warn('Ø®Ø·Ø§ Ø¯Ø± Ù¾Ø±Ø¯Ø§Ø²Ø´ Ø¢ÛŒØªÙ… Ø±ÙˆØ²Ù†Ø§Ù…Ù‡:', e);
    }
  }

  return newspapers;
}

/**
 * ?????? ????? ????? ?? ???? ???? ???? pishkhan.com
 */
function getTodayPersianDate(): string {
  const today = new Date();
  const persianDate = new Intl.DateTimeFormat('fa-IR', {
    year: 'numeric',
    month: '2-digit',
    day: '2-digit',
    calendar: 'persian',
  }).format(today);

  // ????? ?? ???? ???? ????: 14040916
  const parts = persianDate.split('/');
  if (parts.length === 3) {
    const year = parts[0];
    const month = parts[1];
    const day = parts[2];
    return `${year}${month}${day}`;
  }

  // Fallback: ??????? ?? ????? ????? ?? ???? ??????
  const year = 1404; // ???? ?? ???? ???? ?????? ???
  const month = String(today.getMonth() + 1).padStart(2, '0');
  const day = String(today.getDate()).padStart(2, '0');
  return `${year}${month}${day}`;
}

/**
 * ?????? ???? ?? retry ? timeout
 */
async function fetchWithRetry(
  url: string,
  options: RequestInit = {},
  maxRetries: number = 3,
  timeout: number = 30000
): Promise<Response> {
  let lastError: Error | null = null;

  // Delay ????? ??? ?? ????? ???? (???? ??????? ????????)
  if (maxRetries > 1) {
    await new Promise(resolve => setTimeout(resolve, 500));
  }

  for (let attempt = 0; attempt < maxRetries; attempt++) {
    let timeoutId: NodeJS.Timeout | null = null;
    try {
      // ????? AbortController ???? timeout
      const controller = new AbortController();
      timeoutId = setTimeout(() => controller.abort(), timeout);

      // ????? signal ??
      if (options.signal) {
        // ??? signal ???? ???? ????? ?? ?? ?? ????? ??
        options.signal.addEventListener('abort', () => controller.abort());
      }

      console.log(`?? ???? ${attempt + 1}/${maxRetries} ???? ??????: ${url}`);

      // ??????? ?? fetch (?? Next.js 16 ?? undici ??????? ??????)
      const fetchFn = undiciFetch || globalThis.fetch;

      const response = await fetchFn(url, {
        ...options,
        signal: controller.signal,
        // ?????? ??????? ???? ????? ????
        headers: {
          ...options.headers,
          'Connection': 'keep-alive',
          'Cache-Control': 'no-cache',
        },
        // ?? Next.js 16? ????????? ?? next.revalidate ??????? ????
        next: { revalidate: 0 },
      } as any);

      if (timeoutId) {
        clearTimeout(timeoutId);
      }

      if (!response.ok) {
        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
      }

      console.log(`? ?????? ???? ?? ???? ${attempt + 1}`);
      return response;

    } catch (error: any) {
      if (timeoutId) {
        clearTimeout(timeoutId);
      }
      lastError = error;

      // ??????? ?????? ???
      const errorDetails = {
        name: error.name,
        message: error.message,
        code: error.code,
        cause: error.cause,
        stack: error.stack?.split('\n').slice(0, 3).join('\n'),
      };

      // ??? ?????? ???
      console.warn(`? ??? ?? ???? ${attempt + 1}/${maxRetries}:`, {
        name: errorDetails.name,
        message: errorDetails.message,
        code: errorDetails.code,
        cause: errorDetails.cause?.message || errorDetails.cause,
      });

      // ??? ???? abort ??? (timeout)? ???? ????? ???
      if (error.name === 'AbortError' || error.message?.includes('timeout') || error.code === 'ETIMEDOUT') {
        console.warn(`?? Timeout ?? ???? ${attempt + 1}/${maxRetries}`);
      } else if (error.code === 'ECONNRESET' || error.message?.includes('ECONNRESET') || error.cause?.code === 'ECONNRESET') {
        console.warn(`?? ??? ????? ?? ???? ${attempt + 1}/${maxRetries} - ????? ???? ???? ??? ??`);
      } else if (error.code === 'ENOTFOUND' || error.code === 'EAI_AGAIN') {
        console.warn(`?? ???? DNS ?? ???? ${attempt + 1}/${maxRetries} - ??? ????? ???? ???`);
      } else if (error.code === 'ECONNREFUSED' || error.message?.includes('ECONNREFUSED')) {
        console.warn(`?? ????? ?? ?? ?? ???? ${attempt + 1}/${maxRetries} - ???? ??????? ?? ?? ???`);
      } else if (error.message?.includes('fetch failed')) {
        // ???? ????? fetch - ?????? ????? ?? cause ????
        const causeMsg = error.cause?.message || error.cause?.code || '??????';
        console.warn(`?? ???? ????? ?? ???? ${attempt + 1}/${maxRetries}: ${causeMsg}`);
      }

      // ??? ????? ???? ????? ????? ???? ? ?????? ???? ??
      if (attempt < maxRetries - 1) {
        // Exponential backoff ?? delay ????? ???? ??????? ????????
        const baseDelay = 2000; // ???? ?? 2 ?????
        const delay = Math.min(baseDelay * Math.pow(2, attempt), 10000); // ?????? 10 ?????
        // ????? ???? ??? randomness ???? ??????? ?? ???????
        const jitter = Math.random() * 1000; // 0-1 ????? ??????
        const totalDelay = delay + jitter;
        console.log(`? ????? ${Math.round(totalDelay)}ms ??? ?? ???? ????...`);
        await new Promise(resolve => setTimeout(resolve, totalDelay));
      }
    }
  }

  // ??? ??? ??????? ?????? ?????
  const errorInfo = lastError ? {
    message: lastError.message || '??????',
    code: (lastError as any).code || (lastError as any).cause?.code || '??????',
    name: lastError.name || 'Error',
    cause: (lastError as any).cause?.message || (lastError as any).cause || '??????',
  } : { message: '??????', code: '??????', name: 'Error', cause: '??????' };

  const errorMessage = `?????? ?? ?????? ${url} ?? ?? ${maxRetries} ????. ` +
    `???: ${errorInfo.message} (??: ${errorInfo.code})`;

  console.error('? ???? ?????:', {
    url,
    attempts: maxRetries,
    error: errorInfo,
  });

  throw new Error(errorMessage);
}

/**
 * GET: ?????? ???? ??????????
 * Query params:
 *   - forceDownload: ??? true ????? PDF??? ?? ??? ??? ????? ?????? ???????? ?????? ?????? ??????
 */
export async function GET(request: Request) {
  try {
    // ??????? query params
    const { searchParams } = new URL(request.url);
    const forceDownload = searchParams.get('forceDownload') === 'true';

    // ?????? ??????? ?? ???????
    const enabledSetting = await prisma.siteSetting.findUnique({
      where: { key: 'newspaper_rss_enabled' },
    });

    const urlSetting = await prisma.siteSetting.findUnique({
      where: { key: 'newspaper_rss_url' },
    });

    // ????? ???? ????
    if (enabledSetting?.value !== 'true') {
      return NextResponse.json({
        success: false,
        message: '?????????? ??????? ?????',
        newspapers: [],
      });
    }

    // ?? ???? ???? (???? forceDownload)? PDF??? ?????? ????????
    // ??? ??????? ????????? ??????? (?? ???? ???? ??? ?? ??? ?????? ??? ????)
    if (!forceDownload) {
      console.log(`?? ?? ??? ?????? ???? ?????????? (???? ?????? PDF)`);
    } else {
      console.log(`?? ?? ??? ?????? ? ?????? PDF ?????????? (forceDownload=true)`);
    }

    // ?????? URL ?? ??????? ?? ??????? ?? ???????
    let sourceUrl = urlSetting?.value || 'https://www.pishkhan.com';

    // ????? ??? ????: RSS feed ?? HTML page
    if (isRSSFeed(sourceUrl)) {
      // ??????? ?? RSS feed
      console.log(`?? ?????? ?????????? ?? RSS feed: ${sourceUrl}`);

      const newspapers = await extractNewspapersFromRSS(sourceUrl);

      // ??? ????????? ?? ???? URL ? ??????? ?? ??? ?????
      const uniqueNewspapers = newspapers
        .filter((paper, index, self) =>
          index === self.findIndex(p => p.name === paper.name || p.persianName === paper.persianName)
        )
        .map(paper => ({
          name: paper.persianName, // ??????? ?? ??? ?????
          url: paper.url,
          pdfUrl: (paper as any).pdfUrl, // ????? ???? ???? PDF
          englishName: paper.name, // ???? ??????? ?? slug
        }));

      console.log(`? ${uniqueNewspapers.length} ??????? ?? RSS feed ???? ??`);

      return NextResponse.json({
        success: true,
        count: uniqueNewspapers.length,
        newspapers: uniqueNewspapers,
      });
    } else {
      // ??????? ?? HTML scraping (???? pishkhan.com)
      let pageUrl = sourceUrl;

      // ??? URL ???? ??? ?? ??? ????? ???? URL ???? ????
      if (!pageUrl || pageUrl === 'https://www.pishkhan.com' || pageUrl === 'https://www.pishkhan.com/') {
        const todayDate = getTodayPersianDate();
        pageUrl = `https://www.pishkhan.com?date=${todayDate}&type=economics`;
      } else if (pageUrl.includes('/economics')) {
        // ??? URL ???? /economics ???? ???? ?? ??????? ?? (???? ?????)
        // ??? ???? ???? ??? ??????????? ??????? ?? ????
        pageUrl = pageUrl;
      } else {
        // ??? URL ?? ??????? ????? ?? ?? ??????? ?? ??? ??????? ??
        // ??? ??? type ????? ? /economics ?? ?????? ????? ??
        if (!pageUrl.includes('type=') && !pageUrl.includes('/economics')) {
          pageUrl += (pageUrl.includes('?') ? '&' : '?') + 'type=economics';
        }
      }

      console.log(`?? ?????? ??????????? ??????? ?? HTML: ${pageUrl}`);

      // ?????? ???? ?? retry ? timeout
      const response = await fetchWithRetry(
        pageUrl,
        {
          headers: {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
            'Accept-Language': 'fa-IR,fa;q=0.9,en-US;q=0.8,en;q=0.7',
            'Connection': 'keep-alive',
            'Accept-Encoding': 'gzip, deflate, br',
          },
        },
        4, // maxRetries (?????? ?? 4 ????)
        45000 // timeout: 45 seconds (?????? ???? ??????? ???)
      );

      const html = await response.text();

      // ??????? ??????????? ??????? (?? ????? URL ???? ????? ???? economics ? forceDownload)
      const newspapers = await extractEconomicNewspapers(html, pageUrl, forceDownload);

      // ??? ????????? ?? ???? URL ? ??????? ?? ??? ?????
      const uniqueNewspapers = newspapers
        .filter((paper, index, self) =>
          index === self.findIndex(p => p.name === paper.name || p.persianName === paper.persianName)
        )
        .map(paper => {
          // ??????? ?? ????? englishName ???? ??? (??? ???? ??????? ?? URL)
          const englishName = paper.name; // ??? ??? ???? ?? URL ??????? ??? ???
          return {
            name: paper.persianName, // ??????? ?? ??? ?????
            url: paper.url,
            pdfUrl: (paper as any).pdfUrl, // ????? ???? ???? PDF
            englishName: englishName, // ???? ??????? ?? slug - ??? ???? ?? URL
          };
        });

      console.log(`? ${uniqueNewspapers.length} ??????? ??????? ?? HTML ???? ??`);

      return NextResponse.json({
        success: true,
        count: uniqueNewspapers.length,
        newspapers: uniqueNewspapers,
      });
    }

  } catch (error: any) {
    console.error('? ??? ?? ?????? ??????????:', error);
    return NextResponse.json(
      {
        success: false,
        message: error.message || '??? ?? ?????? ??????????',
        newspapers: [],
      },
      { status: 500 }
    );
  }
}

